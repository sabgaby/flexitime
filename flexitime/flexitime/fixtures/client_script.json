[
  {
    "doctype": "Client Script",
    "name": "Employee - Integrations Tab",
    "dt": "Employee",
    "view": "Form",
    "enabled": 1,
    "module": "Flexitime",
    "script": "frappe.ui.form.on('Employee', {\n\trefresh: function(frm) {\n\t\t// Only show Integrations tab content for the employee's own record\n\t\tif (frm.doc.user_id !== frappe.session.user && !frappe.user.has_role('System Manager')) {\n\t\t\tfrm.set_df_property('integrations_tab', 'hidden', 1);\n\t\t\treturn;\n\t\t}\n\n\t\t// Show tab and load Google Workspace status\n\t\tfrm.set_df_property('integrations_tab', 'hidden', 0);\n\t\tload_google_workspace_status(frm);\n\t}\n});\n\nfunction load_google_workspace_status(frm) {\n\t// Check connection status from integration_hub\n\tfrappe.call({\n\t\tmethod: 'integration_hub.oauth.get_connection_status',\n\t\tcallback: function(r) {\n\t\t\tconst status = r.message || {};\n\n\t\t\t// Get enabled services from Google Workspace Settings\n\t\t\tfrappe.call({\n\t\t\t\tmethod: 'frappe.client.get_value',\n\t\t\t\targs: {\n\t\t\t\t\tdoctype: 'Google Workspace Settings',\n\t\t\t\t\tfieldname: ['enabled', 'enable_calendar', 'enable_drive', 'enable_gmail']\n\t\t\t\t},\n\t\t\t\tcallback: function(settings_response) {\n\t\t\t\t\tconst settings = settings_response.message || {};\n\t\t\t\t\trender_google_workspace_html(frm, status, settings);\n\t\t\t\t},\n\t\t\t\terror: function() {\n\t\t\t\t\t// Google Workspace Settings might not exist\n\t\t\t\t\trender_google_workspace_html(frm, status, { enabled: false });\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\terror: function() {\n\t\t\t// integration_hub might not be installed\n\t\t\trender_google_workspace_html(frm, { is_connected: false }, { enabled: false });\n\t\t}\n\t});\n}\n\nfunction render_google_workspace_html(frm, status, settings) {\n\t// If Google Workspace integration is not enabled globally, show message\n\tif (!settings.enabled) {\n\t\tfrm.fields_dict.google_workspace_status_html.$wrapper.html(`\n\t\t\t<div class=\"text-muted\" style=\"padding: 15px 0;\">\n\t\t\t\t<p>Google Workspace integration is not enabled for this site.</p>\n\t\t\t\t<p class=\"text-xs\">Contact your administrator to enable Google Workspace integration.</p>\n\t\t\t</div>\n\t\t`);\n\t\treturn;\n\t}\n\n\tlet services_html = '<ul class=\"list-unstyled mb-3\" style=\"margin-left: 0; padding-left: 0;\">';\n\tif (settings.enable_calendar) {\n\t\tservices_html += '<li style=\"margin-bottom: 4px;\">üìÖ <strong>Calendar</strong> - Leave events sync to your calendar</li>';\n\t}\n\tif (settings.enable_drive) {\n\t\tservices_html += '<li style=\"margin-bottom: 4px;\">üìÅ <strong>Drive</strong> - Access shared files</li>';\n\t}\n\tif (settings.enable_gmail) {\n\t\tservices_html += '<li style=\"margin-bottom: 4px;\">üìß <strong>Gmail</strong> - Email integration</li>';\n\t}\n\tservices_html += '</ul>';\n\n\tlet html = '';\n\n\tif (status.is_connected) {\n\t\thtml = `\n\t\t\t<div class=\"google-workspace-status\" style=\"padding: 15px 0;\">\n\t\t\t\t<div style=\"display: flex; align-items: center; margin-bottom: 12px;\">\n\t\t\t\t\t<span class=\"indicator-pill green\" style=\"margin-right: 8px;\">Connected</span>\n\t\t\t\t\t<span class=\"text-muted\">Your Google account is connected</span>\n\t\t\t\t</div>\n\t\t\t\t<p style=\"margin-bottom: 8px;\"><strong>Enabled Services:</strong></p>\n\t\t\t\t${services_html}\n\t\t\t\t<button class=\"btn btn-sm btn-default\" onclick=\"disconnect_google_workspace()\">\n\t\t\t\t\tDisconnect\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t`;\n\t} else {\n\t\thtml = `\n\t\t\t<div class=\"google-workspace-status\" style=\"padding: 15px 0;\">\n\t\t\t\t<div style=\"display: flex; align-items: center; margin-bottom: 12px;\">\n\t\t\t\t\t<span class=\"indicator-pill red\" style=\"margin-right: 8px;\">Not Connected</span>\n\t\t\t\t\t<span class=\"text-muted\">Connect to enable Google services</span>\n\t\t\t\t</div>\n\t\t\t\t<p style=\"margin-bottom: 8px;\"><strong>Available Services:</strong></p>\n\t\t\t\t${services_html}\n\t\t\t\t<button class=\"btn btn-sm btn-primary\" onclick=\"connect_google_workspace()\">\n\t\t\t\t\t<svg width=\"14\" height=\"14\" viewBox=\"0 0 16 16\" fill=\"currentColor\" style=\"margin-right: 4px;\">\n\t\t\t\t\t\t<path d=\"M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z\"/>\n\t\t\t\t\t\t<path d=\"M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z\"/>\n\t\t\t\t\t</svg>\n\t\t\t\t\tConnect Google Account\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\tfrm.fields_dict.google_workspace_status_html.$wrapper.html(html);\n}\n\n// Global functions for button onclick handlers\nwindow.connect_google_workspace = function() {\n\tfrappe.call({\n\t\tmethod: 'integration_hub.oauth.get_authorization_url',\n\t\targs: {\n\t\t\tredirect_to: window.location.pathname\n\t\t},\n\t\tcallback: function(r) {\n\t\t\tif (r.message) {\n\t\t\t\twindow.location.href = r.message;\n\t\t\t}\n\t\t}\n\t});\n};\n\nwindow.disconnect_google_workspace = function() {\n\tfrappe.confirm(\n\t\t__('Are you sure you want to disconnect your Google account? This will disable calendar sync for your leave applications.'),\n\t\tfunction() {\n\t\t\tfrappe.call({\n\t\t\t\tmethod: 'integration_hub.oauth.disconnect',\n\t\t\t\tcallback: function() {\n\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\tmessage: __('Google account disconnected'),\n\t\t\t\t\t\tindicator: 'blue'\n\t\t\t\t\t});\n\t\t\t\t\tcur_frm.reload_doc();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t);\n};"
  }
]
